# 抓包和报文回放

### tcpdump

```
-c  在收到指定的数量的分组后，tcpdump就会停止
-e  在输出行打印出数据链路层的头部信息
-i  指定监听的网络接口
-n  不把网络地址转换成名字
-nn 不进行端口名称的转换
-vv 输出详细的报文信息
-w 直接将分组写入文件中，后面跟随文件路径
```

![image-20240919193733045](tcpdump和wireshark.assets/image-20240919193733045.png)

https://blog.csdn.net/ljbcharles/article/details/122256796

[全网最详细的 tcpdump 使用指南 - 王一白 - 博客园 (cnblogs.com)](https://www.cnblogs.com/wongbingming/p/13212306.html)

### wireshark

![image-20240919193801263](抓包和报文回放.assets/image-20240919193801263.png)

![image-20240919193814096](tcpdump和wireshark.assets/image-20240919193814096.png)

https://blog.csdn.net/a745233700/article/details/102774703

[网络分析工具——WireShark的使用（超详细）-CSDN博客](https://blog.csdn.net/zzwwhhpp/article/details/113077747)

### tcpreplay

**下载**

```sh
yum install -y tcpreplay
```

**基础使用**

```shell
-i 指定回放接口
--listnics  查看本机有哪些接口
-l, --loop=num


# 基本参数
-q, --quiet: 静默模式，减少输出。
-T, --timer: 选择数据包的定时模式（如 select, ioport, gtod, nano）。
--maxsleep: 设置数据包之间的最大休眠时间（毫秒）。
-v, --verbose: 使用 tcpdump 解码数据包并输出到标准输出。
-A, --decode: 传递给 tcpdump 解码器的参数（需配合 --verbose）。
-K, --preload-pcap: 在发送前将数据包预加载到内存中。
-c, --cachefile: 使用 tcpprep 缓存文件分流（需要 intf2，禁止 dualfile）。
-2, --dualfile: 从网络接口同时重放两个文件（需要 intf2，禁止 cachefile）。
# 网络接口
-i, --intf1: 指定客户端到服务器/主流量输出接口。
-I, --intf2: 指定服务器到客户端/次流量输出接口。
-w, --write: 将流量输出到 pcap 文件（禁止 intf2，可替代 intf1）。
# 数据包选择
--include: 仅发送选定的数据包编号（禁止 exclude）。
--exclude: 发送除选定编号以外的数据包（禁止 include）。
# 循环和速度控制
-l, --loop: 指定循环播放的次数。
--loopdelay-ms: 循环之间的延迟（毫秒，需配合 loop）。
--loopdelay-ns: 循环之间的延迟（纳秒，需配合 loop）。
-L, --limit: 限制发送的数据包数量。
--duration: 限制发送的秒数。
-x, --multiplier: 调整重放速度的倍数。
-p, --pps: 以每秒数据包数重放。
-M, --mbps: 以 Mbps 重放。
-t, --topspeed: 尽可能快地重放数据包。
-o, --oneatatime: 每次用户输入重放一个数据包。
# 其他功能
--unique-ip: 每次循环时修改 IP 地址以生成唯一流（需配合 loop）。
--no-flow-stats: 禁止输出和追踪流量统计。
-P, --pid: 启动时打印 tcpreplay 的 PID。
--stats: 每 X 秒或每次循环打印统计信息。
-W, --suppress-warnings: 禁止打印警告信息。
-V, --version: 打印版本信息。
-h, --less-help: 显示简化使用信息并退出。
-H, --help: 显示详细使用信息并退出。
```

**基本重放**

重放一个 pcap 文件到指定接口：
```bash
tcpreplay --intf1=eth0 capture.pcap
```

**设置重放速度**

以每秒 1000 个数据包的速度重放：
```bash
tcpreplay --intf1=eth0 --pps=1000 capture.pcap
```

**指定循环次数**

将 pcap 文件循环重放 5 次：
```bash
tcpreplay --intf1=eth0 --loop=5 capture.pcap
```

**使用速率倍增器**

以 2 倍速率重放：
```bash
tcpreplay --intf1=eth0 --multiplier=2 capture.pcap
```

**以最大速度重放**

尽可能快地重放数据包：
```bash
tcpreplay --intf1=eth0 --topspeed capture.pcap
```

**预加载到内存**

将数据包预加载到内存中再发送：
```bash
tcpreplay --intf1=eth0 --preload-pcap capture.pcap
```

**解码并输出**

使用 `tcpdump` 解码数据包并输出：
```bash
tcpreplay --intf1=eth0 --verbose --decode="-n" capture.pcap
```

**仅发送特定数据包**

发送特定编号的数据包：
```bash
tcpreplay --intf1=eth0 --include=1,3,5 capture.pcap
```

这些示例可以帮助你快速上手 `tcpreplay`，根据你的需求调整参数即可实现不同的重放场景。

#### 使用tcprewirte

```shell
# 修改IP
tcprewrite --infile=input.pcap --outfile=output.pcap --dstipmap=old_ip:new_ip
tcprewrite --infile=input.pcap --outfile=output.pcap --srcipmap=old_ip:new_ip

# 修改mac
tcprewrite --infile=input.pcap --outfile=output.pcap --enet-dmac=new_mac
tcprewrite --infile=input.pcap --outfile=output.pcap --enet-smac=new_mac

# 修改port
tcprewrite --infile=input.pcap --outfile=output.pcap --dstportmap=old_port:new_port
tcprewrite --infile=input.pcap --outfile=output.pcap --srcportmap=old_port:new_port

# 交换源目的IP地址以及端口号
tcprewrite --infile=input.pcap --outfile=output.pcap --endpoints=swap
```

[Tcpreplay 、tcpprep、tcprewrite 修改报文使用教程-CSDN博客](https://blog.csdn.net/abcdu1/article/details/121126129)

### goreplay

- Goreplay 是用 Golang 写的一个 HTTP 实时流量复制工具。功能更强大，支持流量的放大、缩小，频率限制，还支持把请求记录到文件，方便回放和分析，也支持和 ElasticSearch 集成，将流量存入 ES 进行实时分析。
- GoReplay 不是代理，而是监听网络接口上的流量，不需要更改生产基础架构，而是在与服务相同的计算机上运行 GoReplay 守护程序。
- GoReplay 是一个用于捕获和重放 HTTP 流量的工具。以下是一些常用参数的解释：

### 常用参数

- **`-input-raw`**: 捕获指定端口的流量（需要 sudo 权限）。
  
  ```bash
  gor --input-raw :8080 --output-http http://staging.com
  ```
```
  
- **`-output-http`**: 将请求转发到指定 HTTP 地址。
  ```bash
  gor --input-raw :80 --output-http http://staging.com
```

- **`-http-allow-url`**: 使用正则表达式过滤 URL。
  ```bash
  gor --input-raw :8080 --output-http staging.com --http-allow-url ^www.
  ```

- **`-http-rewrite-url`**: 根据映射重写请求 URL。
  ```bash
  gor --input-raw :8080 --output-http staging.com --http-rewrite-url /v1/user/([^\/]+)/ping:/v2/user/$1/ping
  ```

- **`-http-set-header`**: 为 HTTP 请求注入额外的头。
  ```bash
  gor --input-raw :8080 --output-http staging.com --http-set-header 'User-Agent: Gor'
  ```

- **`-output-file`**: 将请求写入文件。
  ```bash
  gor --input-raw :80 --output-file ./requests.gor
  ```

- **`-input-file`**: 从文件读取请求。
  ```bash
  gor --input-file ./requests.gor --output-http staging.com
  ```

- **`-split-output`**: 将流量均匀分配到所有输出。
  ```bash
  gor --input-raw :80 --output-http staging1.com --output-http staging2.com --split-output true
  ```

- **`-verbose`**: 设置详细级别，打开调试输出。
  ```bash
  gor --input-raw :80 --output-http staging.com --verbose 1
  ```

### 过滤和修改

- **`-http-allow-header`**: 过滤符合正则表达式的 HTTP 头。
- **`-http-disallow-header`**: 过滤不符合正则表达式的 HTTP 头。
- **`-http-allow-method`**: 允许的 HTTP 方法白名单。

### 性能和调试

- **`-http-pprof`**: 启用性能分析。
- **`-stats`**: 打开队列统计输出。

这些选项可以帮助你灵活地捕获和重放 HTTP 流量，同时进行过滤和修改，以便在不同环境中测试应用程序。

[HTTP流量拷贝测试神器GoReplay_goreplay 响应结果对比-CSDN博客](https://blog.csdn.net/cjf_iceking/article/details/121436093)